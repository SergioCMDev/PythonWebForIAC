name: Docker Image CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  login-build:
    runs-on: self-hosted
    env:
      K8S_NAMESPACE: "default"
      K8S_DEPLOYMENT: "python-basic-web"
      CLUSTER_NAME: "Mi-cluster"
      AWS_REGION: "eu-west-3"
      ingress: "main-ingress"
      namespace: "default"
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Configurar kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"
      - name: Checkout source code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Docker permissions
        run: |
          sudo usermod -aG docker $USER
          newgrp docker
      - name: Check which service needs to be updated
        run: |
          echo "Checking which service(blue or green) needs to be updated..." 
          BLUE_WEIGHT=$(kubectl get ingress ${{ env.ingress }} -n ${{ env.K8S_NAMESPACE }} -o json -o json | \
          jq -r '.metadata.annotations."alb.ingress.kubernetes.io/actions.weighted-routing" | fromjson | .forwardConfig.targetGroups[] | select(.serviceName=="app-blue-service") | .weight')

          if [ "$BLUE_WEIGHT" -eq 100 ]; then
            CHANGE_TO_GREEN=1
          fi
      - name: Build the Docker image
          if [ "${{ env.CHANGE_TO_GREEN }}" -eq 1 ]; then
          echo "Selecting V2 for Green service"
          Docker_VERSION=Green
          else
          echo "Selecting V1 for Blue service"
          Docker_VERSION=Blue
          fi
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROJECT }}:${{ env.Docker_VERSION}} .
      - name: Push the Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROJECT }}:${{ env.Docker_VERSION}}
      - name: Setup EKS access
        run: |
          cd /opt/scripts
          sudo sed -i 's/\r$//' ./configure_eks_script.sh
          bash ./configure_eks_script.sh ${{ env.CLUSTER_NAME }} ${{ env.AWS_REGION }}
        shell: bash
      - name: initial blue Green Deployment to Kubernetes
        run: |
          cd /opt/scripts
          bash ./blue_green_updater.sh  ${{ env.K8S_NAMESPACE }} ${{ env.ingress }} ${{ env.BLUE_WEIGHT }} ${{ env.GREEN_WEIGHT }}
        env:
          BLUE_WEIGHT: 50
          GREEN_WEIGHT: 50
      - name: Wait for blue-green change Kubernetes Deployment
        run: |
          echo "Waiting for 2 minutes to stabilize the deployment..."
          sleep 120
      - name: Change the rest to the other service
        run: |
          cd /opt/scripts
          if [ "${{ env.CHANGE_TO_GREEN }}" -eq 1 ]; then
            echo "Changing 100% to Green service"
            BLUE_WEIGHT=0
            GREEN_WEIGHT=100
          else
            echo "Changing 100% to Blue service"
            BLUE_WEIGHT=100
            GREEN_WEIGHT=0
          fi
          bash ./blue_green_updater.sh  ${{ env.K8S_NAMESPACE }} ${{ env.ingress }} $BLUE_WEIGHT $GREEN_WEIGHT
      - name: Verificar rollout
        run: |
          echo "Esperando que el rollout se complete..."
          kubectl rollout status deployment/${{ env.K8S_DEPLOYMENT }} \
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=2m

      - name: Verificar estado de los pods
        if: always()
        run: |
          echo "Estado de los pods despu√©s del deployment:"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.K8S_DEPLOYMENT }}

      - name: Rollback en caso de fallo
        if: failure()
        run: |
          echo "Realizando rollback del deployment..."
          if [ "${{ env.CHANGE_TO_GREEN }}" -eq 1 ]; then
            echo "Changing 100% to Green service"
            BLUE_WEIGHT=100
            GREEN_WEIGHT=0
          else
            echo "Changing 100% to Blue service"
            BLUE_WEIGHT=0
            GREEN_WEIGHT=100
          fi
          bash ./blue_green_updater.sh  ${{ env.K8S_NAMESPACE }} ${{ env.ingress }} $BLUE_WEIGHT $GREEN_WEIGHT
env:
  CHANGE_TO_GREEN: 0
  Docker_VERSION: 0
