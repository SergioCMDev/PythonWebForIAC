name: Docker Image CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  login-build:
    runs-on: self-hosted
    env:
      K8S_NAMESPACE: "default"
      CLUSTER_NAME: "mi-cluster"
      AWS_REGION: "eu-west-3"
      ingress: "main-ingress"
      namespace: "default"
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Configurar kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"
      - name: Checkout source code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Docker permissions
        run: |
          sudo usermod -aG docker $USER
          newgrp docker
      - name: Setup EKS access
        run: |
          cd /opt/scripts
          sudo sed -i 's/\r$//' ./configure_eks_script.sh
          bash ./configure_eks_script.sh ${{ env.CLUSTER_NAME }} ${{ env.AWS_REGION }}
        shell: bash

      - name: Check which service needs to be updated
        run: |
          echo "Comprobando que servicio necesita ser actualizado..." 
          BLUE_WEIGHT=$(kubectl get ingress ${{ env.ingress }} -n ${{ env.K8S_NAMESPACE }} -o json | \
          jq -r '.metadata.annotations."alb.ingress.kubernetes.io/actions.weighted-routing" | fromjson | .forwardConfig.targetGroups[] | select(.serviceName=="app-blue-service") | .weight')

          if [ "$BLUE_WEIGHT" -eq 100 ]; then
            echo "Selecting Green service"
            TARGET="green"
          else
            echo "Selecting Blue service"
            TARGET="blue"
          fi

          TIMESTAMP=$(date +%s)
          GIT_SHA=$(git rev-parse --short HEAD)
          BUILD_NUMBER=${{ github.run_number }}
          UNIQUE_TAG="${TARGET}-${GIT_SHA}-${BUILD_NUM}"
          LATEST_TAG="${TARGET}"

          echo "UNIQUE_TAG=$UNIQUE_TAG" >> $GITHUB_ENV
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "DEPLOYMENT_TARGET=$TARGET" >> $GITHUB_ENV

      - name: Build the Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROJECT }}:${{ env.UNIQUE_TAG }} .
          docker tag ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROJECT }}:${{ env.UNIQUE_TAG }} \
          ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROJECT }}:${{ env.LATEST_TAG }}

      - name: Push the Docker images
        run: |
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROJECT }}:${{ env.UNIQUE_TAG}}
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROJECT }}:${{ env.LATEST_TAG}}

      - name: Update deployment
        run: |
          kubectl set image deployment/app-${{ env.DEPLOYMENT_TARGET }} \
          python-basic-web=${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROJECT }}:${{ env.UNIQUE_TAG }} \
          -n ${{ env.K8S_NAMESPACE }}

      - name: initial blue Green Deployment to Kubernetes
        run: |
          cd /opt/scripts
          bash ./blue_green_updater.sh  ${{ env.K8S_NAMESPACE }} ${{ env.ingress }} ${{ env.BLUE_WEIGHT }} ${{ env.GREEN_WEIGHT }}
        env:
          BLUE_WEIGHT: 50
          GREEN_WEIGHT: 50

      - name: Wait for blue-green change Kubernetes Deployment
        run: |
          echo "Esperando 1 minuto para estabilizacion del deployment..."
          sleep 60

      - name: Change the rest to the other service
        run: |
          cd /opt/scripts
          if [ "${{ env.DEPLOYMENT_TARGET }}" == "green" ]; then
            echo "Cambiando 100% a Green"
            BLUE_WEIGHT=0
            GREEN_WEIGHT=100
          else
            echo "Cambiando 100% a Blue"
            BLUE_WEIGHT=100
            GREEN_WEIGHT=0
          fi
          bash ./blue_green_updater.sh  ${{ env.K8S_NAMESPACE }} ${{ env.ingress }} $BLUE_WEIGHT $GREEN_WEIGHT

      - name: Verificar rollout
        run: |
          echo "Verificando el estado del rollout del deployment..."
          kubectl rollout status deployment/app-${{ env.DEPLOYMENT_TARGET }}\
            -n ${{ env.K8S_NAMESPACE }} \
            --timeout=2m

      - name: Verificar estado de los pods
        if: always()
        run: |
          echo "Estado de los pods despu√©s del deployment:"
          kubectl get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ secrets.DOCKER_PROJECT }},version=${{ env.DEPLOYMENT_TARGET }}

      - name: Rollback en caso de fallo
        if: failure()
        run: |
          echo "Realizando rollback del deployment..."
          if [ "${{ env.DEPLOYMENT_TARGET }}" == "green" ]; then
            echo "Cambiando 100% a Blue"
            BLUE_WEIGHT=100
            GREEN_WEIGHT=0
          else
            echo "Cambiando 100% a Green"
            BLUE_WEIGHT=0
            GREEN_WEIGHT=100
          fi
          cd /opt/scripts
          bash ./blue_green_updater.sh  ${{ env.K8S_NAMESPACE }} ${{ env.ingress }} $BLUE_WEIGHT $GREEN_WEIGHT
env:
  UNIQUE_TAG: ""
  LATEST_TAG: ""
  DEPLOYMENT_TARGET: ""
