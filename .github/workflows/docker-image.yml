name: Docker Image CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  login-build:
    runs-on: self-hosted
    env:
      K8S_NAMESPACE: "default"
      K8S_DEPLOYMENT: "python-basic-web"
      CLUSTER_NAME: "Mi-cluster"
      AWS_REGION: "eu-west-3"
      ingress: "main-ingress"
      namespace: "default"
    steps:
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Configurar kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "latest"
      - name: Checkout source code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Docker permissions
        run: |
          sudo usermod -aG docker $USER
          newgrp docker
      - name: Build the Docker image
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROJECT }}:v2 .
      - name: Push the Docker image
        run: docker push ${{ secrets.DOCKER_USERNAME }}/${{ secrets.DOCKER_PROJECT }}:v2
      - name: Setup EKS access
        run: |
          cd /opt/scripts
          sudo sed -i 's/\r$//' ./configure_eks_script.sh
          bash ./configure_eks_script.sh ${{ env.CLUSTER_NAME }} ${{ env.AWS_REGION }}
          aws sts get-caller-identity

        shell: bash
      - name: Blue Green Deployment to Kubernetes
        run: |
          cd /opt/scripts
          sudo sed -i 's/\r$//' ./blue_green_updater.sh
          bash ./blue_green_updater.sh  ${{ env.K8S_NAMESPACE }} ${{ env.ingress }} ${{ env.BLUE_WEIGHT }} ${{ env.GREEN_WEIGHT }}
        env:
          BLUE_WEIGHT: 50
          GREEN_WEIGHT: 50
      # - name: Verificar rollout
      #   run: |
      #     echo "Esperando que el rollout se complete..."
      #     sudo kubectl --kubeconfig=/home/ec2-user/.kube/config rollout status deployment/${{ env.K8S_DEPLOYMENT }} \
      #       -n ${{ env.K8S_NAMESPACE }} \
      #       --timeout=10m

      # - name: Verificar estado de los pods
      #   if: always()
      #   run: |
      #     echo "Estado de los pods despu√©s del deployment:"
      #     sudo kubectl --kubeconfig=/home/ec2-user/.kube/config get pods -n ${{ env.K8S_NAMESPACE }} -l app=${{ env.K8S_DEPLOYMENT }}

      # - name: Rollback en caso de fallo
      #   if: failure()
      #   run: |
      #     echo "Realizando rollback del deployment..."
      #     kubectl --kubeconfig=/home/ec2-user/.kube/config rollout undo deployment/${{ env.K8S_DEPLOYMENT }} -n ${{ env.K8S_NAMESPACE }}
