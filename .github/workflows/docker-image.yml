name: Docker Image CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  ECR_REPOSITORY: python_web_app
jobs:
  login-build:
    runs-on: ubuntu-latest

    # Permisos necesarios para OIDC
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout source code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}
          role-session-name: GitHubActions-ECR-Push

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Generate unique image tag
        id: generate-tag
        run: |
          GIT_SHA=$(git rev-parse --short HEAD)
          BUILD_NUMBER=${{ github.run_number }}
          TIMESTAMP=$(date +%s)

          IMAGE_TAG="${GIT_SHA}-${BUILD_NUMBER}-${TIMESTAMP}"

          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "GIT_SHA=$GIT_SHA" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT

          echo "Image tag: $IMAGE_TAG"

      - name: Build the Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.generate-tag.outputs.IMAGE_TAG }}
          GIT_SHA_TAG: ${{ steps.generate-tag.outputs.GIT_SHA }}
        run: |
          docker build \
          --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
          --build-arg VCS_REF=$GIT_SHA_TAG \
          --build-arg VERSION=$IMAGE_TAG \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:$GIT_SHA_TAG \
          -t $ECR_REGISTRY/$ECR_REPOSITORY:stable .
      - name: Debug Image_REF
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.generate-tag.outputs.IMAGE_TAG }}
          IMAGE_REF: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.generate-tag.outputs.IMAGE_TAG }}
        run: "echo Running image $IMAGE_REF ${{env.IMAGE_REF}}"

      - name: Run security scan (Trivy)
        uses: aquasecurity/trivy-action@master
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.generate-tag.outputs.IMAGE_TAG }}
          IMAGE_REF: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.generate-tag.outputs.IMAGE_TAG }}
        with:
          image-ref: ${{ env.IMAGE_REF }}
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Push the Docker images
        env:
          IMAGE_TAG: ${{ steps.generate-tag.outputs.IMAGE_TAG }}
          IMAGE_REF: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ steps.generate-tag.outputs.IMAGE_TAG }}
          IMAGE_REF_STABLE: ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:stable
        run: |
          echo "Pushing image to ECR..."

          docker push ${{env.IMAGE_REF}}
          docker push ${{env.IMAGE_REF_STABLE}}

          echo "Pushed tags:"
          echo "  - ${{env.IMAGE_TAG}} (for production)"
          echo "  - stable (for manual testing)"

      - name: Trigger deployment
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ steps.generate-tag.outputs.IMAGE_TAG }}
          GIT_SHA: ${{ steps.generate-tag.outputs.GIT_SHA }}

        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT_TOKEN }}
          repository: SergioCMDev/Infra-AWS-EKS-Python #Change to secret o asi
          event-type: deploy-app
          client-payload: |
            {
              "image_tag": "${{ env.IMAGE_TAG }}",
              "git_sha": "${{ env.GIT_SHA }}",
              "ecr_registry": "${{ env.ECR_REGISTRY }}",
              "repository": "${{ env.ECR_REPOSITORY }}",
              "triggered_by": "${{ github.actor }}"
            }
